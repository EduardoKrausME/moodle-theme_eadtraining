$(document).ready(function(){$("#change-lang").change(function(){let dataid=$("#editor-dataid").val();let local=$("#editor-local").val();let sesskey=$("#editor-sesskey").val();let selectedValue=$(this).val();$.ajax({url:`actions.php?action=langedit&local=${local}&dataid=${dataid}&lang=${selectedValue}&sesskey=${sesskey}`,method:"POST",dataType:"json",success:function(response){console.log(response);var $message=$(`<div class="alert alert-success m-0 p-2">${response.status}</div>`);$("#change-lang").after($message);setTimeout(function(){$message.remove()},5e3)},error:function(error){console.log(error);var $error=$(`<div class="badge badge-danger m-0 p-2">Request error: ${error}</div>`);$("#change-lang").after($error);setTimeout(function(){$error.remove()},5e3)}})});$("#btn-editor-preview").click(function(){let oldAction=$("#form-save-editor").attr("action");$("#form-save-editor").attr("action",$("#editor-wwwroot").val());$("#form-save-editor").attr("target","editor");$("#form-save-editor").submit();setTimeout(function(){$("#form-save-editor").attr("action",oldAction);$("#form-save-editor").attr("target","_top")},1e3)});let infojson=$("#form-itens-json").val();infojson=atob(infojson);const parsed=JSON.parse(infojson);const $formItens=$("#form-itens .itens");if(parsed.type==="html-form"||parsed.type==="form"){if(parsed.form.label){const $label=$("<h6>").addClass("text-center").html(parsed.form.label);$formItens.parent().prepend($label)}if(parsed.form.title){const $title=$("<h2>").addClass("text-center").html(parsed.form.title);$formItens.parent().prepend($title)}if(parsed.form.info){const $message=$("<div>").addClass("container alert alert-warning mt-4").html(parsed.form.info);$formItens.parent().parent().append($message)}if(parsed.form.block){const $block=$("<div>").addClass("form-group");$formItens.append($block);$.each(parsed.form.block,function(fieldId,fieldConfig){if(!isNumeric(fieldId)){renderField($block,parsed.form.block,false,parsed?.savedata,fieldId,fieldConfig)}})}if(parsed.form.blocks){renderBlocksForm();$formItens.sortable({placeholder:"ui-state-highlight"});$formItens.disableSelection()}}function renderBlocksForm(){const $container=$("<div>").attr("id","multi-blocks-container");$formItens.append($container);$("#btn-add-block").show().on("click",function(){const $block=$("<div>").addClass("form-group");$formItens.append($block);renderFields($block,parsed.form.blocks,true);$formItens.animate({scrollTop:$formItens[0].scrollHeight},500)});let num=0;if(parsed?.savedata){$.each(parsed?.savedata,function(id,savedata){if(isNumeric(id)){const $block=$("<div>").addClass("form-group");$formItens.append($block);renderFields($block,parsed.form.blocks,true,savedata);num++}})}if(num==0){const $block=$("<div>").addClass("form-group");$formItens.append($block);renderFields($block,parsed.form.blocks,true)}}function renderFields($block,fieldsDef,multiple,savedata){if(parsed.numElement==undefined){parsed.numElement=0}else{parsed.numElement++}$.each(fieldsDef,function(fieldId,fieldConfig){renderField($block,fieldsDef,multiple,savedata,fieldId,fieldConfig)});if(multiple){$block.addClass("form-group-multiple");const $delete=$("<span>").addClass("block-delete").text("✕");$block.find("label:first-child").append($delete);$delete.click(function(){confirmPopup({title:"Remover bloco",message:"Deseja remover este bloco?",okText:"Sim, remover",cancelText:"Não",danger:true}).then(function(ok){if(ok){$block.remove()}})})}}function renderField($block,fieldsDef,multiple,savedata,fieldId,fieldConfig){const $label=$("<label>").text(fieldConfig.label).attr("for",fieldId);let $input;let inputname=multiple?`save[${parsed.numElement}][${fieldId}]`:`save[${fieldId}]`;switch(fieldConfig.type){case"text":$input=$("<input>").addClass("form-control").attr("type","text").attr("name",inputname);break;case"textarea":$input=$("<textarea>").addClass("form-control").attr("name",inputname);break;case"number":$input=$("<input>").addClass("form-control").attr("type","number").attr("name",inputname);break;case"select":$input=$("<select>").addClass("form-control").attr("name",inputname);if(typeof fieldConfig?.data==="string"){loadSelectOptions($input,fieldConfig.data,function(){if(savedata&&savedata[fieldId]!=undefined){$input.val(savedata[fieldId])}})}else if(Array.isArray(fieldConfig?.data)){fieldConfig.data.forEach(opt=>{var $option=$("<option>").val(opt.id).text(opt.name).prop("selected",fieldConfig?.default_data==opt.id);$input.append($option)})}break}if(!multiple){$input.attr("id",fieldId)}if(savedata&&savedata[fieldId]!=undefined){$input.val(savedata[fieldId])}if(fieldConfig.placeholder){$input.attr("placeholder",fieldConfig.placeholder)}$block.append($label,$input)}function loadSelectOptions($selectElement,dataKey,callback){$selectElement.empty().append($("<option>").text("Carregando...").prop("disabled",true).prop("selected",true));return fetchSelectOptionsCached(dataKey).then(function(options){$selectElement.empty();$selectElement.append($("<option>").text("..."));$.each(options,function(i,opt){$selectElement.append($("<option>").val(opt.id).text(opt.name))});if(typeof callback==="function"){callback()}return options}).catch(function(){$selectElement.empty().append($("<option>").text("Error loading data").prop("disabled",true))})}function isNumeric(value){if(typeof value==="number"){return Number.isFinite(value)}if(typeof value!=="string"){return false}value=value.trim();if(value===""){return false}return Number.isFinite(Number(value))}var selectOptionsCache;function fetchSelectOptionsCached(dataKey){if(!selectOptionsCache){selectOptionsCache=new Map}if(selectOptionsCache.has(dataKey)){return selectOptionsCache.get(dataKey)}const dataid=$("#editor-dataid").val();const lang=$("#editor-lang").val();const local=$("#editor-local").val();const sesskey=$("#editor-sesskey").val();const req=$.getJSON(`actions.php?action=loaddata&dataid=${dataid}&lang=${lang}&local=${local}&sesskey=${sesskey}&datakey=${dataKey}`).then(function(options){return Array.isArray(options)?options:[]}).catch(function(err){selectOptionsCache.delete(dataKey);throw err});selectOptionsCache.set(dataKey,req);return req}function confirmPopup(options={}){const opts={title:options.title??"Confirmação",message:options.message??"Tem certeza?",okText:options.okText??"Remover",cancelText:options.cancelText??"Cancelar",danger:options.danger??true};if(!document.getElementById("confirm-popup-overlay")){const css=`
                #confirm-popup-overlay{
                    position:fixed; inset:0; background:rgba(0,0,0,.45);
                    display:none; align-items:center; justify-content:center;
                    z-index:99999; padding:16px;
                }
                #confirm-popup{
                    width:min(520px, 100%);
                    background:#fff; border-radius:14px;
                    box-shadow:0 16px 40px rgba(0,0,0,.25);
                    overflow:hidden;
                    transform: translateY(8px); opacity:0;
                    transition: transform .12s ease, opacity .12s ease;
                    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
                }
                #confirm-popup-overlay.is-open #confirm-popup{
                    transform: translateY(0); opacity:1;
                }
                #confirm-popup header{
                    padding:14px 16px; border-bottom:1px solid rgba(0,0,0,.08);
                    font-weight:700; font-size:16px;
                }
                #confirm-popup .body{
                    padding:14px 16px; font-size:14px; line-height:1.4;
                    color: rgba(0,0,0,.78);
                }
                #confirm-popup footer{
                    padding:12px 16px; display:flex; gap:10px; justify-content:flex-end;
                    border-top:1px solid rgba(0,0,0,.08);
                }
                .confirm-btn{
                    border:0; border-radius:10px; padding:10px 14px;
                    cursor:pointer; font-weight:600; font-size:14px;
                }
                .confirm-btn.cancel{
                    background: rgba(0,0,0,.06);
                }
                .confirm-btn.ok{
                    background: rgba(25,118,210,.12);
                }
                .confirm-btn.ok.danger{
                    background: rgba(220,53,69,.14);
                }
                .confirm-btn:focus{ outline: 2px solid rgba(25,118,210,.35); outline-offset: 2px; }`;$("<style>").text(css).appendTo("head");const html=`
                <div id="confirm-popup-overlay" role="dialog" aria-modal="true" aria-hidden="true">
                  <div id="confirm-popup">
                    <header id="confirm-popup-title"></header>
                    <div class="body" id="confirm-popup-message"></div>
                    <footer>
                      <button type="button" class="confirm-btn cancel" id="confirm-popup-cancel"></button>
                      <button type="button" class="confirm-btn ok" id="confirm-popup-ok"></button>
                    </footer>
                  </div>
                </div>`;$("body").append(html)}const $overlay=$("#confirm-popup-overlay");const $title=$("#confirm-popup-title");const $message=$("#confirm-popup-message");const $btnCancel=$("#confirm-popup-cancel");const $btnOk=$("#confirm-popup-ok");$title.text(opts.title);$message.text(opts.message);$btnCancel.text(opts.cancelText);$btnOk.text(opts.okText);$btnOk.toggleClass("danger",!!opts.danger);return new Promise(resolve=>{let resolved=false;function close(result){if(resolved)return;resolved=true;$(document).off("keydown.confirmPopup");$overlay.off("click.confirmPopup");$btnCancel.off("click.confirmPopup");$btnOk.off("click.confirmPopup");$overlay.removeClass("is-open").hide().attr("aria-hidden","true");resolve(result)}$overlay.on("click.confirmPopup",function(e){if(e.target===this)close(false)});$btnCancel.on("click.confirmPopup",function(){close(false)});$btnOk.on("click.confirmPopup",function(){close(true)});$(document).on("keydown.confirmPopup",function(e){if(e.key==="Escape")close(false);if(e.key==="Enter")close(true)});$overlay.css({display:"flex"}).addClass("is-open").attr("aria-hidden","false");setTimeout(()=>$btnCancel.trigger("focus"),0)})}});